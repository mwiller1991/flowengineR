---
title: "In Detail: Execution Engine - Adaptive Batchtools SLURM Stability"
subtitle: "Adaptive output execution on SLURM clusters with batchtools"
author: "mwiller"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{In Detail: Execution Engine - Adaptive Batchtools SLURM Stability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

> **Summary**  
> This vignette describes the **SLURM**-based adaptive output execution using `batchtools` on HPC clusters.  
> It explains cluster-side dispatch, resource templates, and how the engine aggregates results and stability diagnostics back into the standardized `flowengineR` outputs.

---

## Engine: Adaptive Batchtools SLURM Stability (`engine_execution_adaptive_output_batchtools_slurm`)

### Purpose and Function
This engine conducts adaptive stability monitoring via SLURM-based batchtools execution. In each iteration, a batch of jobs (each handling one data split) is submitted to a SLURM cluster. The monitored metric is checked for convergence using a specified strategy, and the process stops upon stability or after a maximum number of splits.

### Input Structure (via Wrapper)

**Standardized Inputs:**
- `control`: The full control object (⚠️ provided directly by the workflow).
- `split_output`: Dummy 1-split result used to validate compatibility (⚠️ provided directly by the workflow).
- `params`: Configuration of the stability logic and SLURM environment

### Engine-specific Parameters

| Parameter                  | Type       | Default                                                   | Description                                                  |
|---------------------------|------------|-----------------------------------------------------------|--------------------------------------------------------------|
| `metric_name`             | character  | `"mse"`                                                   | Metric to monitor                                            |
| `metric_source`           | character  | `"eval_mse"`                                              | Engine that provides the monitored metric                    |
| `stability_strategy`      | character  | `"cohen_absolute"`                                        | Strategy for convergence                                     |
| `threshold`               | numeric    | `0.2`                                                     | Threshold for convergence                                    |
| `window`                  | integer    | `3`                                                       | Number of trailing metrics used in comparison                |
| `min_splits`              | integer    | `5`                                                       | Minimum iterations before checking for convergence           |
| `max_splits`              | integer    | `50`                                                      | Maximum iterations before stopping                           |
| `custom_stability_function` | function | `NULL`                                                    | Optional custom function for stability                       |
| `seed_base`               | integer    | `2000`                                                    | Base seed for split generation                               |
| `n_splits_per_iteration`  | integer    | `3`                                                       | Number of splits per SLURM job batch                         |
| `registry_folder`         | character  | `"~/flowengineR/tests/BATCHTOOLS/bt_SLURM_adaptive_output/bt_registry_SLURM"` | Registry path |
| `slurm_template`          | character  | `"~/flowengineR/tests/BATCHTOOLS/bt_SLURM_adaptive_output/default.tmpl"` | Path to SLURM job template |
| `seed`                    | integer    | `123`                                                     | Seed for registry creation                                   |
| `required_packages`       | character[]| `character(0)`                                            | Packages loaded in each SLURM job                            |
| `resources`               | list       | `{ncpus=1, memory=2048, walltime=3600}`                   | SLURM job specifications                                     |

### Output Structure

Structured via `initialize_output_execution()`:

- `execution_type`: `"adaptive_output_batchtools_slurm"`
- `workflow_results`: Results from all submitted jobs
- `params`: Parameter configuration used
- `continue_workflow`: Always `TRUE`
- `specific_output`:
    - `metric_name`, `metric_source`
    - `values`: All recorded metric values
    - `split_output`: Reconstructed full split object
    - `used_seeds`: All used seed values

### Workflow Integration

- **Controller Function:** `controller_execution()`
- **Engine Wrapper:** `wrapper_execution_adaptive_output_batchtools_slurm()`
- **Position in Flow:** Adaptive execution phase using cluster infrastructure

### Template Reference

This engine's control template is located at:  
`inst/templates_control/2_2_c_template_execution_adaptive_output_batchtools_slurm.R`

### Example Configuration
```r
control$engine_select$execution <- "execution_adaptive_output_batchtools_slurm"
control$params$execution <- controller_execution(
  params = list(
    metric_name = "mse",
    metric_source = "eval_mse",
    stability_strategy = "cohen_absolute",
    threshold = 0.2,
    window = 3,
    min_splits = 5,
    max_splits = 50,
    seed_base = 2000,
    n_splits_per_iteration = 3,
    registry_folder = "~/flowengineR/tests/BATCHTOOLS/bt_SLURM_adaptive_output/bt_registry_SLURM",
    slurm_template = "~/flowengineR/tests/BATCHTOOLS/bt_SLURM_adaptive_output/default.tmpl",
    seed = 123,
    required_packages = c("caret", "dplyr"),
    resources = list(ncpus = 2, memory = 4096, walltime = 3600)
  )
)
```
